While MPACT has the capability to solve the Boltzmann transport equation using the 3D Method of Characteristics, doing so is too computationally burdensome to be of practical value.  To obtain accurate solutions to the equation more quickly, a method known as 2D/1D is employed.  This method takes advantage of the geometry in LWRs by exploiting the fact that most of the material heterogeneities (and thus sharp flux gradients) occur only in the radial direction.  Axially, the reactor is typically almost uniform for a given radial point.  This allows the detailed, expensive transport calculations to be done in 2D instead of 3D.  A much faster, lower order calculation can then be done in the axial direction to couple a ``stack'' of 2D planar solutions to obtain 3D flux shapes.  This chapter is devoted to discussing the derivation of the 2D/1D equations, how some of the methods from chapter \ref{chap:transport} are applied to the these equations in MPACT, and some of the approximations and limitations of the 2D/1D method.

\section{Derivation}

\subsection{Radial Equations}

To begin, equation \ref{e:multigroupboltzmann} \hl{or Sn equation?} must be integrated in the $z$-direction over some range $\Delta z_i = z_{i+\frac{1}{2}} - z_{i-\frac{1}{2}}$, giving:

\begin{dmath}
{\Omega_x\frac{\partial \psi_{g,z}}{\partial x} + \Omega_y\frac{\partial \psi_{g,z}}{\partial y} + \frac{\Omega_z}{\Delta z_i}\left(\psi_{g,z_{i+\frac{1}{2}}} - \psi_{g,z_{i-\frac{1}{2}}}\right)} + {\Sigma_{t,g}\left(x,y\right)\psi_{g,z}\left(x,y,\bm\Omega\right)} = {\frac{1}{4\pi}\sum_{g'=1}^{G}\intop_{4\pi}\Sigma_{s,g'\rightarrow g,z}\left(x,y,\bm\Omega'\cdot\bm\Omega\right)\psi_{g',z}\left(x,y,\bm\Omega'\right)d\Omega'} + {\frac{1}{k_{eff}}\frac{\chi_{g,z}}{4\pi}\sum_{g'=1}^G\intop_{4\pi} \nu\Sigma_{f,g',z}\left(x,y\right)\psi_{g',z}\left(x,y,\bm\Omega'\right)d\Omega'} + {\frac{Q_{g,z}\left(x,y\right)}{4\pi}}
\end{dmath}

The $z$-component of the streaming can now be moved to the right-hand side of the equation and treated as a source term.

\begin{subequations}
\begin{dmath}
{\Omega_x\frac{\partial \psi_{g,z}}{\partial x} + \Omega_y\frac{\partial \psi_{g,z}}{\partial y}} + {\Sigma_{t,g}\left(x,y\right)\psi_{g,z}\left(x,y,\bm\Omega\right)} = {q_{g,z}\left(x,y\right) + L_{g,z}\left(x,y,\Omega_z\right)}
\end{dmath}
\begin{dmath}
q_{g,z}\left(x,y\right) = {\frac{1}{4\pi}\sum_{g'=1}^{G}\intop_{4\pi}\Sigma_{s,g'\rightarrow g,z}\left(x,y,\bm\Omega'\cdot\bm\Omega\right)\psi_{g',z}\left(x,y,\bm\Omega'\right)d\Omega'} + {\frac{1}{k_{eff}}\frac{\chi_{g,z}}{4\pi}\sum_{g'=1}^G\intop_{4\pi} \nu\Sigma_{f,g',z}\left(x,y\right)\psi_{g',z}\left(x,y,\bm\Omega'\right)d\Omega'} + {\frac{Q_{g,z}\left(x,y\right)}{4\pi}}
\end{dmath}
\begin{equation}
L_{g,z}\left(x,y,\Omega_z\right) = \frac{\Omega_z}{\Delta z_i}\left(\psi_{g,z_{i-\frac{1}{2}}} - \psi_{g,z_{i+\frac{1}{2}}}\right)
\end{equation}
\end{subequations}

$L_{g,z}\left(x,y,\Omega_z\right)$ is the axial transverse leakage source term for plane $z$.  To simplify the source term, the axial transverse leakage term is often handled isotropically.  This is done by averaging over angle:

\begin{equation}
L_{g,z}\left(x,y\right) = \frac{1}{4\pi}\intop L_{g,z}\left(x,y,\Omega_z\right) \approx \frac{J_{g,z_{i-\frac{1}{2}}} - J_{g,z_{i+\frac{1}{2}}}}{4\pi\Delta z_i}
\end{equation}

Other methods exist that allow the axial transverse leakage source to maintain its angular dependence\todo{Cite Blake and others}, but this work always used the isotropic treatment for the sake of simplicity and efficiency.

\subsection{Axial Equations}

The axial equations can be derived in a manner similar to the radial equations.  We begin with equation \ref{e:multigroupboltzmann} and average over an x-y area:

\begin{subequations}
\begin{dmath}
{\Omega_z \frac{\partial \psi_{g,x,y}}{\partial z}} + {\Sigma_{t,g}\left(z\right)\psi_{g,x,y}\left(z,\bm\Omega\right)} = q_{g,x,y}\left(z,\Omega_x,\Omega_y\right) + {L_{g,x,y}\left(z,\Omega_x,\Omega_y\right)}
\end{dmath}
\begin{dmath}
q_{g,x,y}\left(z,\Omega_x,\Omega_y\right) = {\frac{1}{4\pi}\sum_{g'=1}^G\intop_{4\pi} \Sigma_{s,g'\rightarrow g,x,y}\left(z,\bm\Omega'\cdot\bm\Omega\right)\psi_{g',x,y}\left(z,\bm\Omega'\right)d\Omega'} + {\frac{1}{k_{eff}}\frac{\chi_{g,x,y}}{4\pi}\sum_{g'=1}^G\intop_{4\pi}\nu\Sigma_{f,g',x,y}\left(z\right)\psi_{g',x,y}\left(z,\bm\Omega'\right)d\Omega'} + {\frac{Q_{g,x,y}\left(z\right)}{4\pi}}
\end{dmath}
\begin{dmath}
L_{g,x,y}\left(z,\Omega_x,\Omega_y\right) = {\frac{\Omega_x}{\Delta x_i \Delta y_i}\intop_{y_{i-\frac{1}{2}}}^{y_{i+\frac{1}{2}}} \left(\psi_{g,x_{i-\frac{1}{2}},y_i} - \psi_{g,x_{i+\frac{1}{2}},y_i} dy\right)} + {\frac{\Omega_y}{\Delta x_i \Delta y_i}\intop_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \left(\psi_{g,x_i,y_{i-\frac{1}{2}}} - \psi_{g,x_i,y_{i+\frac{1}{2}}} dx\right)}
\end{dmath}
\end{subequations}

As with the radial equations, we can again treat the transverse leakage source as being isotropic by averaging over angle:

\begin{dmath}
{L_{g,x,y}\left(z\right)} = {\frac{1}{4\pi}\intop_{4\pi} L_{g,x,y}\left(z,\Omega_x,\Omega_y\right)} \approx {\frac{1}{4\pi\Delta x_i\Delta y_i}\intop_{y_{i-\frac{1}{2}}}^{y_{i+\frac{1}{2}}}\left( J_{g,x_{i-\frac{1}{2}},y_i}\left(z\right) - J_{g,x_{i+\frac{1}{2}},y_i}\left(z\right)\right)dy} + {\frac{1}{4\pi\Delta x_i\Delta y_i}\intop_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}\left( J_{g,x_i,y_{i-\frac{1}{2}}}\left(z\right) - J_{g,x_i,y_{i+\frac{1}{2}}}\left(z\right)\right)dx}
\end{dmath}

Again, methods have been developed to angle the angle-dependence of the radial transverse leakage source\todo{Cite Shane and anyone else who has done it}, but this work will assume isotropic radial transverse leakage.
\todo{Clean up notation! Radial too!}

\section{Implementation}

Now that the general 2D/1D scheme has been described, some attention should be given to the details of its implementation in MPACT.  Figure \ref{f:2d1d-flowchart} shows the calculation flow used by MPACT.  The first step is to perform a global 3D CMFD calculation to obtain pin-averaged flux and interface currents between each cell.  Next, the axial solver uses the radial currents calculated by CMFD as a radial transverse leakage source to obtain an axial transverse leakage source for the radial solver.  Finally, 2D MOC is used as the radial solver to obtain a solution with sub-pin resolution in each plane.

\begin{figure}
\centering
\input{figs/2d1d-flowchart.tex}
\caption{Calculation flow for 2D/1D scheme}\label{f:2d1d-flowchart}
\end{figure}
\todo{Simplify this flowchart into large blocks of cmfd, nodal, moc}
\todo{Use other smaller flowcharts in subsections}

\subsection{3D Sub-plane CMFD}

The CMFD method was originally implemented in MPACT just as described in section \todo{section num}.  To do this, each pin cell is homogenized using the quantities defined in equation \ref{e:CMFDhomogTerms} in every plane in the model.  The radial coupling coefficients defined in equation \ref{e:CMFDcouplingCoeffs} are obtained by calculating the current at the interface between each pair of pin cells using the 2D MOC sweeper, while the axial coupling coefficients are obtained from the axial currents calculated by the axial solve during the previous iteration.  The matrix for the 3D multi-group system can then be set up and solved, typically using the generalized Davidson eigenvalue solver.

In addition to this traditional 3D CMFD, MPACT also has the capability to use the sublpane scheme\todo{citations}.  This scheme was first implemented in the DeCART code to allow users to increase the thickness of the 2D planes while still maintaining the accuracy of a fine axial mesh.  This eliminated some convergence difficulties associated with thin 2D planes \todo{citation?} and reduced the computational burden of performing MOC on many thin planes.  However, the sub-plane scheme is also being employed as a framework to develop new control rod decusping methods (discussed in more detail in chapter \ref{chap:decusping}).


\subsubsection{Homogenization}

The difference between the sub-plane scheme and traditional CMFD is that the CMFD system is that the CMFD system is allowed to have multiple axial planes for each of the 2D planes in which the transport calculations are done.  This allows CMFD to capture sub-plane axial flux shapes that would otherwise be ignored.  To do this, a sub-plane scaling factor is introduced which will be used to provide an axial shape within a 2D plane:

\begin{align}
\c_{g,i}^k &= \frac{\phi_{g,i}^{k-1}}{\overline{\phi}_{g,i}^{k-1}} \nonumber\\
 &= \frac{\phi_{g,i}^{k-1} \sum_{i'=1}^{N_{sp}} V_{i'}}{\sum_{i'=1}^{N_{sp}} \phi_{g,i'}^{k-1} V_{i'}}
\end{align}

where superscripts indicate which iteration the values are taken from and $N_{sp}$ is the number of sub-planes for the pin cell of interest.  Now when the homogenized values are calculated from the 2D transport solution using equation \ref{e:CMFDhomogTerms}, the fine mesh flux is multiplied by this sub-plane scaling factor everywhere it appears.  Because the 2D/1D scheme assumes a constant material axially in each plane, this sub-plane factor has no impact on the homogenized cross-sections.  However, the homogenized flux $\phi_{g,i}$ and fission source distribution $\chi_{g,i}$ will be changed, providing an axial shape for the source term in the eigenvalue calculation.

\subsubsection{Coupling Coefficients}

In addition to the homogenized cell terms, the coupling coefficients described by equations \ref{e:CMFDinterface} and \ref{e:CMFDcouplingCoeffs} must be calculated for each sublpane.  To maintain consistency, the area-averaged current calculated by the radial sweeper must be preserved across the sub-surfaces used by the sub-plane scheme.  Thus, the current calculated by the radial sweeper at an interface is used at the corresponding interfaces for all sub-planes in that plane.  Additionally, to maintain consistency, this requires that the cell-homogenized flux used in the calculation of the diffusion coefficients be defined for the entire MOC plane as in equation \ref{e:CMFDhomogFlux} rather than using the sub-plane scaling factor for each sub-plane.  \hl{Additional work is currently underway to address this limitation, but at this time using sub-plane--dependent coupling coefficients prevents many realistic problems from converging.}

The axial coupling coefficient can be treated in a more straightforward manner.  Because the 1D axial solvers use the same pin-homogenized mesh as the CMFD solver, axial currents are naturally calculated at the top and bottom of each of the sub-planes.  Thus, these currents can be used together with the sub-planes fluxes to calculate sub-plane--dependent axial coupling coefficients.

\subsubsection{Projection}

The projection of the CMFD flux back to the 2D planes must also account for the presence of the sub-planes.  To do this, the solution is volume-averaged over all sub-planes for each pin cell, resulting in an equation similar to \ref{e:CMFDscaling}:

\begin{equation}
\phi_{trans,g,j}^k = \frac{\sum_{i'=1}^{N_{sp}} \phi_{CMFD,g,i'}^k V_i}{\sum_{i'=1}^{N_{sp}} \phi_{CMFD,g,i'}^k V_i} \phi_{trans,g,j}^{k-1}
\end{equation}

The calculation flow for 3D CMFD is shown in figure \todo{figure num}.

\subsection{1D Axial}

In MPACT, the 1D axial solvers operate on the same mesh as the 3D CMFD calculations, meaning that cell-homogenized quantities and radial currents have already been obtained from the CMFD calculation.  All the 1D axial solver must do is construct a source term from the radial currents for each cell, then perform a calculation to obtain currents on the axial interfaces at the top and bottom of each node.

MPACT has a variety of 1D nodal methods that are capable of performing these calculations, including diffusion-based such as NEM and SENM and higher-order solvers such as SP$_N$ and S$_N$.  For most MPACT calculations, including those in this work, the solver of choice is SP$_3$, which provides significant improvement over the diffusion-based methods and SP$_1$.  Very little benefit is obtained by using the higher-order SP$_5$\todo{citation}.

\subsection{2D MOC}

For the radial calculations, 2D MOC is used.  This allows MPACT to easily calculate scalar fluxes and currents in each plane regardless of the geometric complexity.

\subsubsection{Modular Ray Tracing}



\subsubsection{Angle Correction}



\subsubsection{Volume Correction}



\section{Parallel Decomposition}

\begin{itemize}
\item \hl{space}
\item \hl{angle}
\item \hl{energy}
\item \hl{thread}
\end{itemize}

\section{Sources of Error}

\begin{enumerate}
\item \hl{Ray Spacing}
\item \hl{Radial Meshing}
\item \hl{Axial Meshing}
\item \hl{Axial TL Spatially flat}
\item \hl{Axial TL Isotropic}
\item \hl{Radial TL Spatially flat}
\item \hl{Radial TL Isotropic}
\item \hl{Scattering}
\item \hl{XS Library}
\item \hl{Axial Homogenization}
\item \hl{Quadrature}
\item \hl{Self-Shielding}
\end{enumerate}

\subsection{Axial Homogenization}

One assumption made in the 2D/1D scheme is that each of the 2D planes is axially homogeneous.  In many cases this assumption is true.  Other times, materials such as spacer grids, end plugs for fuel rods and control tips, or other structural materials may be homogenized, but do not have a large impact on the results, making the axial homogenization within a plane a reasonable approximation.  However, when strongly absorbing materials (or others which may significantly impact neutron behavior) are partially inserted into an axial plane, homogenizing them axially can produce large errors in the solution.  When this occurs, the best way to remedy these errors is to divide the plane into 2 or more planes in such a way that the problematic material is no longer partially inserted into a plane.

While there is a known workaround for this approximation, it has the drawback of adding extra planes to the 2D/1D scheme, which in turn increases the computational burden of the calculations.  Because of this, other methods to improve the axial homogenization have been a topic of interest for reactor components that commonly cause this problem, such as control rods.  This will be discussed in more detail in chapter \ref{chap:cusping}.

\subsection{Axial Transverse Leakage Source}

Another significant approximation in 2D/1D relates to the axial transverse leakage source used by the 2D transport solver.  The 1D axial solve and 3D CMFD acceleration are both done on a pin-homogenized coarse mesh.  This results in the assumption that the axial currents are the same in each part of the pin.  Obviously, this is not true since the fuel and moderator regions will have different energy spectra, thus different currents.  This assumption introduces error in source used in the 2D transport calculations.

\subsection{Radial Transverse Leakage Source}